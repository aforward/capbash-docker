#!/bin/bash
[[ -z "$INFO_LEVEL" ]] && source ./submodules/bootstrap/logging

notify "  -- Building DOCKER container $NAME (${LAUNCHER_DIR}/Dockerfile)"
DOCKER_OUTPUT=${LAUNCHER_DIR}/docker_build.log
debug "  -- Run 'tail -f ${DOCKER_OUTPUT}' to watch build logs live"

(cd ${LAUNCHER_DIR} && IGNORE=$(docker build -t $NAME . > $DOCKER_OUTPUT 2>&1))
ERROR="Error building DOCKER container $NAME (${LAUNCHER_DIR}/Dockerfile), due to ..." ./submodules/bootstrap/failonerrors $? $DOCKER_OUTPUT
[ $? -ne 0 ] && exit 1

if [[ ! -z "$VERSION" ]] && [[ "$VERSION" != "latest" ]]; then
  debug "Tagging $NAME $VERSION"

  DOCKER_ID=$(NAME=$NAME ./submodules/docker/image)
  debug "  -- Found $NAME image $DOCKER_ID"
  (cd ${LAUNCHER_DIR} &&  IGNORE=$(docker tag $DOCKER_ID $NAME:$VERSION > $DOCKER_OUTPUT 2>&1))
  ERROR="Error tagging DOCKER container $NAME ($VERSION), due to ..." ./submodules/bootstrap/failonerrors $? $DOCKER_OUTPUT
  [ $? -ne 0 ] && exit 1
  debug "  -- Successgully tagged $NAME $VERSION"
fi
