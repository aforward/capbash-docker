#!/bin/bash
[[ -z "$INFO_LEVEL" ]] && source ./bits/bootstrap/logging

OWNER=${OWNER-$USER}
COPY_OUTPUT=/tmp/copy.log

IFMISSING=${IFMISSING-false}

# TODO: turn into a list
KEY1=$1
VAL1=$2

KEY2=$3
VAL2=$4

KEY3=$5
VAL3=$6

KEY4=$7
VAL4=$8

KEY5=$9
VAL5=${10}

KEY6=${11}
VAL6=${12}


if [[ "$IFMISSING" == true ]]; then

  if [[ ! -e $LOCATION ]]; then
    notify "  -- $LOCATION created"
    OWNER=$OWNER ./bits/bootstrap/cp ${TEMPLATE} ${LOCATION}
  else
    debug "  -- $LOCATION already exists, skipping"
  fi

else

  if [[ "$CODE" == "" ]]; then
    NEWFILE="${TEMPLATE}.copyif"

    cp ${TEMPLATE} ${NEWFILE}

    if [[ -z "$SED_I" ]]; then
      source ./bits/bootstrap/env
    fi

    if [[ "$KEY1" != "" ]]; then
      debug "    >> Applying filter $KEY1 to $VAL1"
      $SED_I "s|$KEY1|$VAL1|g" ${NEWFILE}
    fi

    if [[ "$KEY2" != "" ]]; then
      debug "    >> Applying filter $KEY2 to $VAL2"
      $SED_I "s|$KEY2|$VAL2|g" ${NEWFILE}
    fi

    if [[ "$KEY3" != "" ]]; then
      debug "    >> Applying filter $KEY3 to $VAL3"
      $SED_I "s|$KEY3|$VAL3|g" ${NEWFILE}
    fi

    if [[ "$KEY4" != "" ]]; then
      debug "    >> Applying filter $KEY4 to $VAL4"
      $SED_I "s|$KEY4|$VAL4|g" ${NEWFILE}
    fi

    if [[ "$KEY5" != "" ]]; then
      debug "    >> Applying filter $KEY5 to $VAL5"
      $SED_I "s|$KEY5|$VAL5|g" ${NEWFILE}
    fi

    if [[ "$KEY6" != "" ]]; then
      debug "    >> Applying filter $KEY6 to $VAL6"
      $SED_I "s|$KEY6|$VAL6|g" ${NEWFILE}
    fi

  else
    NEWFILE=${LOCATION}.copyif
    echo "$CODE" > $NEWFILE
  fi

  if [[ ! -e $LOCATION ]]; then
    OWNER=$OWNER ./bits/bootstrap/cp ${NEWFILE} ${LOCATION}
  else
    DIFF=$(diff $NEWFILE $LOCATION) 2> /dev/null

    if [[ "$DIFF" != "" ]]; then
      notify "  -- $LOCATION updated"
      OWNER=$OWNER ./bits/bootstrap/cp ${NEWFILE} ${LOCATION}
    else
      debug "  -- $LOCATION unchanged"
    fi
  fi
  rm -f $NEWFILE

fi
